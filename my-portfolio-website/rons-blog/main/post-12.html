<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Automating AWS EC2 Instance Management with Ansible">
    <meta name="author" content="Ron-Tino">

    <title>Automating AWS EC2 Instance Management with Ansible: A Step-by-Step Tutorial</title>

    <!-- Bootstrap Core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- Custom CSS for Dark Theme -->
    <style>
        body {
            background-color: #121212;
            /* Dark background */
            color: #f8f9fa;
            /* Light text */
        }
        
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: #fff;
            /* White headings */
        }
        
        a {
            color: #64b5f6;
            /* Light blue links */
        }
        
        a:hover,
        a:focus {
            color: #bbdefb;
            /* Lighter blue on hover */
        }
        
        .navbar-default {
            background-color: #212121;
            /* Darker navbar */
            border-color: #37474f;
        }
        
        .navbar-default .navbar-brand {
            color: #bbdefb;
        }
        
        .navbar-default .navbar-brand:hover,
        .navbar-default .navbar-brand:focus {
            color: #fff;
        }
        
        .navbar-default .navbar-nav>li>a {
            color: #cfd8dc;
        }
        
        .navbar-default .navbar-nav>li>a:hover,
        .navbar-default .navbar-nav>li>a:focus {
            color: #fff;
        }
        
        .section-heading {
            color: #fff;
        }
        
        .caption {
            color: #90a4ae;
        }
        
        .post-preview>a {
            color: #fff;
        }
        
        .post-preview>a:focus,
        .post-preview>a:hover {
            color: #bbdefb;
        }
        
        .post-subtitle {
            color: #cfd8dc;
        }
        
        hr {
            border-color: #424242;
        }
        /* Custom Styling for Lists and Code */
        
        .list-group-item {
            background-color: #1e1e1e;
            /* Dark list background */
            color: #f8f9fa;
            /* Light text in lists */
            border-color: #37474f;
        }
        
        pre {
            background-color: #2e2e2e;
            /* Dark code background */
            color: #d4d4d4;
            /* Light code text */
            padding: 10px;
            overflow-x: auto;
            /* Enable horizontal scrolling for long code lines */
        }
        
        code {
            background-color: #2e2e2e;
            /* Dark inline code background */
            color: #d4d4d4;
            /* Light inline code text */
            padding: 2px 5px;
        }
        /* Colorful Accents */
        
        .text-primary {
            color: #4dd0e1;
            /* Cyan accent */
        }
        
        .bg-primary {
            background-color: #4dd0e1;
            /* Cyan background accent */
        }
        
        header.intro-header {
            margin-top: 100px;
            padding-top: 100;
            height: inherit;
        }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="index.html">DevOps Automation wi Ron-Tino</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="index.html">Home</a>
                    </li>
                    <li>
                        <a href="about.html">About</a>
                    </li>
                    <li>
                        <a href="post.html"></a>
                    </li>
                    <li>
                        <a href="contact.html">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <div style="display: flex; flex-direction: column; align-items:center;">
                            <img src="img/2nJIuDzpq5f3Zib7gCC5aoOc9g.avif" alt="AWS Lambda" width="750" class="tutorial-image">
                        </div>
                        <h1>Automating AWS EC2 Instance Management with Ansible</h1>
                        <h2 class="subheading">Create, Configure, and Manage EC2 Instances with Ansible</h2>
                        <span class="meta">Posted by <a href="#">Ron-Tino</a> on April 10, 2025</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h2 class="section-heading">Challenge</h2>
                <p>The challenge is to automate the provisioning and management of EC2 instances on AWS using Ansible.</p>

                <h3 class="section-heading">Tasks</h3>
                <ul>
                    <li>Create three(3) EC2 instances on AWS using Ansible loops.
                        <ul>
                            <li>2 Instances with Ubuntu Distribution</li>
                            <li>1 Instance with Centos Distribution</li>
                        </ul>
                    </li>
                    <li>Set up passwordless authentication between Ansible control node and newly created instances.</li>
                    <li>Automate the shutdown of Ubuntu Instances only using Ansible Conditionals.</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                    <!-- Introduction -->
                    <h2 class="section-heading">Introduction</h2>
                    <p>In this tutorial, we'll walk through how to use Ansible to automate the creation and management of EC2 instances on AWS. We'll cover creating instances with different Linux distributions, setting up passwordless SSH authentication,
                        and automating the shutdown of specific instances based on their OS family. Additionally, we'll use Ansible Vault to securely manage our AWS credentials.
                    </p>

                    <!-- Prerequisites -->
                    <h2 class="section-heading">Prerequisites</h2>
                    <ul>
                        <li>AWS Account</li>
                        <li>Ansible installed on your control node</li>
                        <li>Basic understanding of AWS and Ansible concepts</li>
                        <li>Python and <code>pip</code> installed</li>
                        <li>AWS CLI installed and configured (optional, for some verification steps)</li>
                    </ul>

                    <!-- Step 1: Setting Up Ansible and AWS Environment -->
                    <h2 class="section-heading">1. Setting Up Ansible and AWS Environment</h2>

                    <!-- 1.1: Install boto3 and AWS Collection -->
                    <h3 class="section-heading">1.1. Install <code>boto3</code> and AWS Collection</h3>
                    <p><code>boto3</code> is the AWS SDK for Python, and the <code>amazon.aws</code> collection provides Ansible modules for interacting with AWS services.</p>

                    <!-- Code Block 1 -->
                    <pre><code>pip install boto3
ansible-galaxy collection install amazon.aws --force</code></pre>
                    <p>The <code>--force</code> flag is used to ensure the collection is reinstalled, resolving any potential version issues.</p>

                    <!-- 1.2: Create an IAM User and Generate Access Keys -->
                    <h3 class="section-heading">1.2. Create an IAM User and Generate Access Keys</h3>
                    <p>Follow these steps to create an IAM user with programmatic access and generate access keys:</p>
                    <ol>
                        <li>In the AWS Management Console, navigate to IAM (Identity and Access Management).</li>
                        <li>Create a new IAM user with programmatic access.</li>
                        <li>Attach the <code>AmazonEC2FullAccess</code> policy to the user (or a more restrictive policy tailored to your needs). <b>Important:</b> For security reasons, it is important to create restrictive policies instead of <code>AmazonEC2FullAccess</code>                            for this project.
                        </li>
                        <li>Generate the access key ID and secret access key for the user.</li>
                    </ol>

                    <!-- 1.3: Setting Up Ansible Vault -->
                    <h3 class="section-heading">1.3. Setting Up Ansible Vault</h3>
                    <p>Ansible Vault is used to encrypt sensitive data, such as AWS credentials, within your Ansible playbooks.
                    </p>

                    <!-- Create a Vault Password File -->
                    <h4 class="section-heading">Create a Vault Password File:</h4>
                    <pre><code>openssl rand -base64 2048 > vault.pass
chmod 600 vault.pass</code></pre>
                    <p>This command generates a random password and stores it in a file with restricted permissions.
                    </p>

                    <!-- Create the Vault Encrypted File -->
                    <h4 class="section-heading">Create the Vault Encrypted File:</h4>
                    <pre><code>ansible-vault create group_vars/all/pass.yml --vault-password-file vault.pass</code></pre>
                    <p>This command creates an encrypted YAML file where you'll store your AWS credentials.</p>

                    <!-- YAML Code Snippet -->
                    <pre><code># group_vars/all/pass.yml
ec2_access_key: YOUR_ACCESS_KEY
ec2_secret_key: YOUR_SECRET_KEY</code></pre>

                    <!-- Step 2: Creating EC2 Instances with Ansible -->
                    <h2 class="section-heading">2. Creating EC2 Instances with Ansible</h2>

                    <!-- 2.1: Create the ec2_create.yaml Playbook -->
                    <h3 class="section-heading">2.1. Create the <code>ec2_create.yaml</code> Playbook:</h3>

                    <!-- YAML Code Snippet -->
                    <pre><code>---
- hosts: localhost
  connection: local
  tasks:
    - name: start an instance with a public IP address
      amazon.aws.ec2_instance:
        name: "{{ item.name }}"
        key_name: "rons-ec2-key"
        instance_type: t2.micro
        security_group: default
        region: us-east-1
        aws_access_key: "{{ lookup('ansible.builtin.file', 'vault.pass') }}"
        aws_secret_key: "{{ lookup('ansible.builtin.file', 'vault.pass') }}"
        network:
          assign_public_ip: true
        image_id: "{{ item.image }}"
        tags:
          environment: "{{ item.image }}"
      loop:
        - {image: "ami-084568db4383264d4", name: "managed-node-1"}
        - {image: "ami-00a929b66ed6e0de6", name: "managed-node-3"}
        - {image: "ami-084568db4383264d4", name: "managed-node-2"}</code></pre>

                    <!-- hosts: localhost and connection: local -->
                    <h4 class="section-heading"><code>hosts: localhost</code> and <code>connection: local</code></h4>
                    <p>This specifies that the playbook will run on the Ansible control node itself. This is required because you want to use the AWS API, not SSH, to create the instances.</p>

                    <!-- tasks: -->
                    <h4 class="section-heading"><code>tasks:</code></h4>
                    <p>Define the actions to be performed.</p>

                    <!-- amazon.aws.ec2_instance -->
                    <h4 class="section-heading"><code>amazon.aws.ec2_instance</code></h4>
                    <p>This is the module from the amazon.aws collection that lets ansible communicate with AWS</p>

                    <!-- loop -->
                    <h4 class="section-heading"><code>loop:</code></h4>
                    <p>This feature allows for many AMI to be created in the same code</p>

                    <!-- 2.2: Execute the Playbook -->
                    <h3 class="section-heading">2.2. Execute the Playbook:</h3>
                    <pre><code>ansible-playbook ec2_create.yaml --vault-password-file vault.pass</code></pre>

                    <!-- 2.3: Verify the Instances -->
                    <h3 class="section-heading">2.3. Verify the Instances:</h3>
                    <p>In the AWS Console, confirm that the three EC2 instances have been created with the specified names and AMIs. You can also use the AWS CLI:</p>
                    <pre><code>aws ec2 describe-instances --region us-east-1</code></pre>

                    <!-- Step 3: Setting Up Passwordless SSH Authentication -->
                    <h2 class="section-heading">3. Setting Up Passwordless SSH Authentication</h2>
                    <p>To enable Ansible to manage the newly created EC2 instances, you need to set up passwordless SSH authentication between the Ansible control node and the instances.</p>

                    <!-- Update inventory.ini -->
                    <h3 class="section-heading">Update <code>inventory.ini</code>:</h3>
                    <p>Add the host information for each instance to your inventory file. Replace the IP addresses with the actual public IP addresses of your EC2 instances:</p>

                    <!-- INI Code Snippet -->
                    <pre><code>[all]
3.83.102.198
54.84.220.118
18.208.169.135

[redhat]
3.83.102.198

[ubuntu]
54.84.220.118
18.208.169.135</code></pre>

                    <!-- Copy SSH Key to Instances -->
                    <h3 class="section-heading">Copy SSH Key to Instances:</h3>
                    <p>Use <code>ssh-copy-id</code> to copy your SSH public key to each instance. You will need the private key associated with the key name provided in your instances to the security to test the connection. Remember to replace the IP addresses,
                        key file, and usernames with the correct values.
                    </p>

                    <!-- Code Block ssh-copy-id -->
                    <pre><code>ssh-copy-id -i ~/.ssh/rons-ec2-key ubuntu@54.84.220.118</code></pre>
                    <p>Repeat this for all instances, adjusting the username for CentOS (usually <code>ec2-user</code>).</p>
                    <p><em>This may work. Add new steps to create ssh keys from local machine and upload them to Ansible
                            server so it can deploy to the created instances.</em></p>
                    <h2 class="section-heading">4. Automating the Shutdown of Ubuntu Instances</h2>
                    <p>Create a playbook to shut down the Ubuntu instances based on the OS family.</p>
                    <h3 class="section-heading">4.1. Create <code>shutdown_ubuntu.yaml</code>:</h3>
                    <pre><code class="language-yaml">---
- name: Shutdown ubuntu instances only
  hosts: all
  become: true

  tasks:
    - name: Shutdown ubuntu instances only
      ansible.builtin.command: /sbin/shutdown -h now
      when: ansible_facts['os_family'] == "Debian"
</code></pre>
                    <h3 class="section-heading">4.2. Run the Playbook:</h3>
                    <pre><code class="language-bash">ansible-playbook shutdown_ubuntu.yaml -k</code></pre>
                    <p>The <code>-k</code> part may be required if you cannot use the ansible vault. It depends. You should specify the location of the keys with <code>-extra var 'key_path=../../keys/aws_key.pem'</code> to have this work</p>
                    <h2 class="section-heading">Congratulations!</h2>
                    <p>You have successfully automated the creation and management of EC2 instances on AWS using Ansible! This detailed guide provides a solid foundation for automating your AWS infrastructure. Experiment with different AMIs, instance types,
                        security groups, and tags to customize your setup. Also, be sure to refine your security practices to ensure your AWS environment is secure.
                    </p>

                </div>
            </div>
        </div>
    </article>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://x.com/Nightwalka11" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.youtube.com/@Ron_can_cloud" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.ron-tino.site/" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-globe fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/Nightwalka" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.linkedin.com/in/ronald-tino-027a6122b" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Copyright © 2024 Ron-Tino</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Theme JavaScript -->
    <script src="js/clean-blog.min.js"></script>

</body>

</html>